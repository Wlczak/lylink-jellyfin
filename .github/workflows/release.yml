name: Build and release Go binaries

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write

jobs:
    build:
        defaults:
            run:
                shell: bash
        strategy:
            matrix:
                include:
                    - go-version: "1.25.1"
                      os: linux
                      runs-on: ubuntu-latest
                    - go-version: "1.25.1"
                      os: windows
                      runs-on: windows-latest
                    - go-version: "1.25.1"
                      os: darwin
                      runs-on: macos-latest
        runs-on: ${{ matrix.runs-on }}
        steps:
            - uses: actions/checkout@v5
            - uses: actions/setup-go@v6
              with:
                  go-version: ${{ matrix.go-version }}
                  cache: false
            - name: Set GOCACHE and GOMODCACHE env
              run: |
                  echo "GOCACHE=$(go env GOCACHE)" >> $GITHUB_ENV
                  echo "GOMODCACHE=$(go env GOMODCACHE)" >> $GITHUB_ENV
            - name: Restore Go caches
              uses: actions/cache@v4
              with:
                  path: |
                      ${{ env.GOCACHE }}
                      ${{ env.GOMODCACHE }}
                  key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}-${{ matrix.go-version }}
                  restore-keys: |
                      ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}-

            - name: Make out dir
              run: mkdir -p out
            - name: Get fyne dependencies for linux
              run: |
                  set -e
                  if [[ "${{ matrix.os }}" == "linux" ]]; then
                    sudo apt-get install gcc libgl1-mesa-dev xorg-dev libxkbcommon-dev
                  fi
            - name: Get fyne && build && package
              run: |
                  set -e
                  go install fyne.io/tools/cmd/fyne@latest
                  "$(go env GOPATH)/bin/fyne" package -os ${{ matrix.os }}
              shell: bash
            # - run: |
            #       mkdir -p out
            #       shopt -s nullglob || true
            #       for f in *myapp*; do
            #         mv "$f" out/ || true
            #       done
            #   shell: bash
            - name: Export binaries
              run: |
                  set -e
                  echo "${{ matrix.os }}"
                  ls -lR
                  if [[ "${{ matrix.os }}" == "windows" ]]; then
                    mv  lylink-jellyfin.exe out/lylink-jellyfin-windows.exe
                  fi
                  if [[ "${{ matrix.os }}" == "linux" ]]; then
                    # tar -czf out/myapp-${{ matrix.os }}.tar.gz -C out .
                    mv lylink-jellyfin.tar.xz out/lylink-jellyfin-${{ matrix.os }}.tar.xz
                  fi
                  if [[ "${{ matrix.os }}" == "darwin" ]]; then
                    mkdir -p out
                    zip -r out/lylink-jellyfin-darwin.zip lylink-jellyfin.app
                  fi
              shell: bash
            - uses: softprops/action-gh-release@v2
              with:
                  files: out/*
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            - name: Save Go caches
              uses: actions/cache@v4
              with:
                  path: |
                      ${{ env.GOCACHE }}
                      ${{ env.GOMODCACHE }}
                  key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}-${{ github.run_id }}
